// ì„œë³´ëª¨í„° ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ í¬í•¨í•©ë‹ˆë‹¤.
#include <Servo.h>


// --- ì„¤ì • ê°’ ---
// ì„œë³´ëª¨í„°ê°€ ì—°ê²°ëœ ì•„ë‘ì´ë…¸ í•€ ë²ˆí˜¸
const int LEFT_SERVO_PIN = 9;
const int RIGHT_SERVO_PIN = 10;


// [ğŸ”„ ìˆ˜ì •ëœ ë¶€ë¶„] ê¸°ë³¸ ì§ì§„ ì†ë„ (ì ¯ìŠ¨ ë‚˜ë…¸ì˜ LANE_KEEP ê°’ê³¼ ì¼ì¹˜ì‹œí‚¤ëŠ” ê²ƒì„ ì¶”ì²œ)
const int LEFT_FORWARD_SPEED = 90;
const int RIGHT_FORWARD_SPEED = 90;


// ì„œë³´ëª¨í„° ì •ì§€ ê°’
const int STOP_SPEED = 90;


// [ğŸ”„ ì¶”ê°€ëœ ë¶€ë¶„] ì ¯ìŠ¨ ë‚˜ë…¸ì˜ ë§ˆì§€ë§‰ ì‹ í˜¸ë¥¼ ë°›ì€ í›„ ê¸°ë³¸ ì§ì§„ ëª¨ë“œë¡œ ëŒì•„ê°€ê¸°ê¹Œì§€ì˜ ì‹œê°„ (ë°€ë¦¬ì´ˆ)
const unsigned long TIMEOUT_MS = 1000; // 1ì´ˆ


// --- ì „ì—­ ë³€ìˆ˜ ---
Servo leftWheel;
Servo rightWheel;


String serialCommand = "";
bool commandComplete = false;


// [ğŸ”„ ì¶”ê°€ëœ ë¶€ë¶„] ë§ˆì§€ë§‰ìœ¼ë¡œ ëª…ë ¹ì„ ìˆ˜ì‹ í•œ ì‹œê°„ì„ ê¸°ë¡í•  ë³€ìˆ˜
unsigned long lastCommandTime = 0;




void setup() {
  Serial.begin(9600);
  Serial.println("Arduino Ready. Default mode: Move Forward.");


  leftWheel.attach(LEFT_SERVO_PIN);
  rightWheel.attach(RIGHT_SERVO_PIN);


  // ì‹œì‘ ì‹œ ì•ˆì „ì„ ìœ„í•´ ì •ì§€
  leftWheel.write(STOP_SPEED);
  rightWheel.write(STOP_SPEED);
  delay(500);


  // ë§ˆì§€ë§‰ ëª…ë ¹ ì‹œê°„ì„ í˜„ì¬ë¡œ ì´ˆê¸°í™” (ì‹œì‘ ì§í›„ ë°”ë¡œ ì§ì§„ ì‹œì‘)
  lastCommandTime = millis();
 
  serialCommand.reserve(32);
}


void loop() {
  // ì ¯ìŠ¨ ë‚˜ë…¸ë¡œë¶€í„° ëª…ë ¹ì–´ê°€ ì™„ì „íˆ ìˆ˜ì‹ ë˜ì—ˆë‹¤ë©´
  if (commandComplete) {
    // ëª…ë ¹ì–´ë¥¼ í•´ì„í•˜ê³  ëª¨í„°ë¥¼ ì œì–´
    parseAndExecuteCommand();


    // [ğŸ”„ ì¶”ê°€ëœ ë¶€ë¶„] ë§ˆì§€ë§‰ ëª…ë ¹ ìˆ˜ì‹  ì‹œê°„ì„ í˜„ì¬ ì‹œê°„ìœ¼ë¡œ ê°±ì‹ 
    lastCommandTime = millis();


    // ë‹¤ìŒ ëª…ë ¹ì–´ë¥¼ ìœ„í•´ ë³€ìˆ˜ ì´ˆê¸°í™”
    serialCommand = "";
    commandComplete = false;
  }


  // [ğŸ”„ ì¶”ê°€ëœ ë¶€ë¶„] ë§ˆì§€ë§‰ ëª…ë ¹ì„ ë°›ì€ ì§€ TIMEOUT_MS ì‹œê°„(1ì´ˆ)ì´ ì§€ë‚¬ëŠ”ì§€ í™•ì¸
  if (millis() - lastCommandTime > TIMEOUT_MS) {
    // 1ì´ˆ ì´ìƒ ì‹ í˜¸ê°€ ì—†ìœ¼ë©´ ê¸°ë³¸ ì§ì§„ ëª¨ë“œë¡œ ì „í™˜
    moveForward();
  }
}


// ì ¯ìŠ¨ ë‚˜ë…¸ë¡œë¶€í„° ë°›ì€ ì‹ í˜¸ë¥¼ ì²˜ë¦¬í•˜ëŠ” ë¶€ë¶„ (ìˆ˜ì • ì—†ìŒ)
void serialEvent() {
  while (Serial.available()) {
    char inChar = (char)Serial.read();
    if (inChar != '\n') {
      serialCommand += inChar;
    } else {
      commandComplete = true;
    }
  }
}


// ì ¯ìŠ¨ ë‚˜ë…¸ì˜ ëª…ë ¹ì„ í•´ì„í•˜ëŠ” ë¶€ë¶„ (ìˆ˜ì • ì—†ìŒ)
void parseAndExecuteCommand() {
  if (serialCommand.startsWith("M")) {
    int firstComma = serialCommand.indexOf(',');
    int secondComma = serialCommand.indexOf(',', firstComma + 1);
    if (firstComma > 0 && secondComma > 0) {
      int leftAngle = serialCommand.substring(firstComma + 1, secondComma).toInt();
      int rightAngle = serialCommand.substring(secondComma + 1).toInt();
      leftWheel.write(leftAngle);
      rightWheel.write(rightAngle);
    }
  }
}


// [ğŸ”„ ì¶”ê°€ëœ ë¶€ë¶„] ê¸°ë³¸ ì§ì§„ í•¨ìˆ˜
void moveForward() {
  leftWheel.write(LEFT_FORWARD_SPEED);
  rightWheel.write(RIGHT_FORWARD_SPEED);
}





